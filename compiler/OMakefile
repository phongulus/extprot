
unsetenv(OCAMLFIND_TOOLCHAIN)

OCAMLINCLUDES =
OCAML_LIBS[]  =

CAMLP5PATH = $(shell ocamlfind query camlp5)
# PARSERS_PATH = $(CAMLP5PATH)/Camlp5Parsers

OCAMLFLAGS += -syntax camlp5o
# -I $(PARSERS_PATH)
OCAMLDEPFLAGS += -syntax camlp5o

OCAMLDEP_MODULES_ENABLED = false

OCAMLPACKS[] +=
	# camlp5.lib
	camlp5.quotations
	unix

EXTPROT_OBJS[] =
	buffer_pool
	codec
	error
	gencode
	gencode_types
	gen_OCaml
	limits
	msg_buffer
	parser
	protocol_types
	pretty_print
	ptypes
	reader
	types

# CAMLP5_OBJS[] =
# 	Camlp5OCamlRevisedParser
# 	Camlp5OCamlParser

section
	OCAMLPACKS[] += camlp5.extend
	OCAMLFLAGS += -w e
	CamlSources(parser)

section
	OCAMLFLAGS += -w e
	CamlSources(protocol_types gencode_types)

section
	OCAMLPACKS[] =
		extlib
		camlp5.macro
	CamlSources(msg_buffer reader)

# OCamlLibrary(libextprotc, $(addprefix $(PARSERS_PATH)/, $(CAMLP5_OBJS)) $(EXTPROT_OBJS))
OCamlLibrary(libextprotc, $(EXTPROT_OBJS))

OCAML_LIBS[] = libextprotc

OCamlProgram(extprotc, extprotc)

.DEFAULT: extprotc$(EXE)

.PHONY: clean
clean:
	rm -f $(filter-proper-targets $(ls R, .)) *.s *.annot *.cmt *.cmti
